# 如何添加新装备及升级版本

本文档以 `IronSword` 和 `IronSwordPlus` 为案例，详细说明如何在游戏中添加一个新装备以及它的升级版本。

## 系统概述

装备系统包含以下四个核心组件，按照以下流程工作：
1. **ShopItem** - 商店中的可购买物品
2. **Equipment** - 背包中的装备实例
3. **Prop** - 地图上的实际道具对象
4. **Template** - 配置数据模板

### 私有字段使用规则

在实现 Prop、Equipment、ShopItem 类时，用来存储数值的私有字段需要遵循以下规则：

- **整数数值**: 使用 `EquipmentValue` 类型
- **攻击伤害类数值**: 使用 `AttackEquipmentValue` 类型

这些特殊类型提供了更好的数值管理和稀有度系统集成。

## 完整实现流程

### 第一步：创建模板文件 (Template)

首先需要创建装备的配置模板，用于存储装备的基础数据。

#### 1.1 基础装备模板
```csharp
// 在 Equipment/Scripts/Templates/ 目录下创建
[CreateAssetMenu(fileName = "New Iron Sword Template", menuName = "Happy Hotel/Item/Iron Sword Template")]
public class IronSwordTemplate : WeaponTemplate
{
    [Header("铁剑属性")]
    public int damage = 3; // 铁剑特有属性
    
    // WeaponTemplate 已经包含了 weaponDamage
    // EquipmentTemplate 已经包含了升级系统相关字段
}
```

#### 1.2 升级版本模板（可选）
**重要提示**: 如果升级版本与基础版本使用相同的字段结构，可以直接复用基础版本的模板类，无需创建新的模板类。只需要在 Unity 编辑器中创建不同配置的模板资源文件即可。

```csharp
// 方案一：复用基础模板类（推荐）
// 升级版本直接使用 IronSwordTemplate 类，通过不同的配置区分

// 方案二：创建独立的升级版模板类（仅当需要额外字段时）
[CreateAssetMenu(fileName = "New Iron Sword Plus Template", menuName = "Happy Hotel/Item/Iron Sword Plus Template")]
public class IronSwordPlusTemplate : WeaponTemplate
{
    [Header("铁剑+属性")]
    public int enhancedDamage = 5; // 升级版特有属性（如果需要额外字段）
}
```

### 第二步：创建 Equipment 类

Equipment 是背包中装备实例的表示。

#### 2.1 基础装备类
```csharp
// Assets/Happy Hotel/Equipment/Scripts/Equipments/IronSword.cs
using HappyHotel.Equipment.Template;
using HappyHotel.Prop;
using HappyHotel.Prop.Setting;
using UnityEngine;

namespace HappyHotel.Equipment
{
    // 铁剑武器实现
    public class IronSword : EquipmentBase
    {
        private int damage;
        
        public int Damage => damage;
        
        public void SetDamage(int newDamage)
        {
            damage = newDamage;
        }
        
        public int GetDamage()
        {
            return damage;
        }

        protected override void OnTemplateSet()
        {
            base.OnTemplateSet();

            if (Template is WeaponTemplate weaponTemplate)
            {
                SetDamage(weaponTemplate.weaponDamage);
            }
        }

        protected override string FormatDescriptionInternal(string formattedDescription)
        {
            // 为铁剑添加特定的占位符替换
            return formattedDescription
                .Replace("{damage}", damage.ToString());
        }
    }
}
```

#### 2.2 升级版装备类
```csharp
// Assets/Happy Hotel/Equipment/Scripts/Equipments/IronSwordPlus.cs
using HappyHotel.Prop;
using HappyHotel.Prop.Setting;
using HappyHotel.Equipment.Template;
using UnityEngine;

namespace HappyHotel.Equipment
{
    // 铁剑+武器实现（铁剑的升级版本）
    public class IronSwordPlus : EquipmentBase
    {
        private int damage;
        
        public int Damage => damage;
        
        public void SetDamage(int newDamage)
        {
            damage = newDamage;
        }
        
        public int GetDamage()
        {
            return damage;
        }
        
        protected override void OnTemplateSet()
        {
            base.OnTemplateSet();
            
            if (Template is WeaponTemplate weaponTemplate)
            {
                damage = weaponTemplate.weaponDamage;
            }
        }
        
        protected override string FormatDescriptionInternal(string formattedDescription)
        {
            // 为铁剑+添加特定的占位符替换
            return formattedDescription
                .Replace("{damage}", damage.ToString())
                .Replace("{weaponType}", "铁剑+")
                .Replace("{effect}", "升级版铁剑，威力更强");
        }
    }
}
```

### 第三步：创建 Prop 类

Prop 是地图上实际的道具对象，包含游戏逻辑。

#### 3.1 基础道具类
```csharp
// Assets/Happy Hotel/Prop/Scripts/Props/IronSwordProp.cs
using HappyHotel.Equipment.Template;
using HappyHotel.Action;
using HappyHotel.Action.Setting;
using HappyHotel.Core.BehaviorComponent;
using HappyHotel.Core.BehaviorComponent.Components;
using HappyHotel.Action.Components;
using HappyHotel.Core.Registry;
using HappyHotel.Prop.Components;
using UnityEngine;

namespace HappyHotel.Prop
{
    // 铁剑道具，被触发时添加一个攻击行动
    [AutoInitComponent(typeof(ActionAdderComponent))]
    public class IronSwordProp : EquipmentPropBase
    {
        private int damage = 3; // 基础伤害
        
        public void SetDamage(int newDamage)
        {
            damage = Mathf.Max(0, newDamage);
        }
        
        public int GetDamage()
        {
            return damage;
        }

        protected override void OnTemplateSet()
        {
            base.OnTemplateSet();
            
            if (template is WeaponTemplate weaponTemplate)
            {
                damage = weaponTemplate.weaponDamage;
            }
        }

        public override void OnTriggerInternal(BehaviorComponentContainer triggerer)
        {
            base.OnTriggerInternal(triggerer);
            
            // 更新ActionAdderComponent的设置
            UpdateActionSettings(damage);
            
            Debug.Log($"铁剑触发: 设置攻击行动，伤害={damage}");
        }
        
        // 更新Action设置
        private void UpdateActionSettings(int damage)
        {
            var actionAdder = GetBehaviorComponent<ActionAdderComponent>();
            if (actionAdder != null)
            {
                var configs = new List<ActionConfig>();
                
                // 添加攻击行动
                var attackTypeId = Core.Registry.TypeId.Create<ActionTypeId>("Attack");
                var attackSetting = new AttackActionSetting(damage);
                configs.Add(new ActionConfig(attackTypeId, attackSetting));
                
                actionAdder.Setup(configs);
            }
        }
        
        protected override string FormatDescriptionInternal(string formattedDescription)
        {
            return formattedDescription
                .Replace("{damage}", damage.ToString())
                .Replace("{weaponType}", "铁剑")
                .Replace("{effect}", "攻击");
        }
    }
}
```

#### 3.2 升级版道具类
```csharp
// Assets/Happy Hotel/Prop/Scripts/Props/IronSwordPlusProp.cs
using HappyHotel.Equipment.Template;
using HappyHotel.Action;
using HappyHotel.Action.Setting;
using HappyHotel.Core.BehaviorComponent;
using HappyHotel.Core.BehaviorComponent.Components;
using HappyHotel.Action.Components;
using HappyHotel.Core.Registry;
using HappyHotel.Prop.Components;
using UnityEngine;

namespace HappyHotel.Prop
{
    // 铁剑+道具，被触发时添加一个攻击行动（升级版本，伤害更高）
    [AutoInitComponent(typeof(ActionAdderComponent))]
    public class IronSwordPlusProp : EquipmentPropBase
    {
        private int damage = 5; // 升级版基础伤害
        private bool isUpgradeVersion = true; // 标记为升级版本
        
        public void SetDamage(int newDamage)
        {
            damage = Mathf.Max(0, newDamage);
        }
        
        public int GetDamage()
        {
            return damage;
        }

        protected override void OnTemplateSet()
        {
            base.OnTemplateSet();
            
            if (template is WeaponTemplate weaponTemplate)
            {
                damage = weaponTemplate.weaponDamage;
            }
        }

        public override void OnTriggerInternal(BehaviorComponentContainer triggerer)
        {
            base.OnTriggerInternal(triggerer);
            
            // 更新ActionAdderComponent的设置
            UpdateActionSettings(damage);
            
            Debug.Log($"铁剑+触发: 设置攻击行动，伤害={damage}");
        }
        
        // 更新Action设置
        private void UpdateActionSettings(int damage)
        {
            var actionAdder = GetBehaviorComponent<ActionAdderComponent>();
            if (actionAdder != null)
            {
                var configs = new List<ActionConfig>();
                
                // 添加攻击行动
                var attackTypeId = Core.Registry.TypeId.Create<ActionTypeId>("Attack");
                var attackSetting = new AttackActionSetting(damage);
                configs.Add(new ActionConfig(attackTypeId, attackSetting));
                
                actionAdder.Setup(configs);
            }
        }
        
        protected override string FormatDescriptionInternal(string formattedDescription)
        {
            string weaponType = isUpgradeVersion ? "铁剑+" : "铁剑";
            string effect = isUpgradeVersion ? "升级版攻击" : "攻击";
            
            return formattedDescription
                .Replace("{damage}", damage.ToString())
                .Replace("{weaponType}", weaponType)
                .Replace("{effect}", effect);
        }
    }
}
```

### 第四步：创建 ShopItem 类

ShopItem 是商店中的可购买物品。

#### 4.1 基础商店物品类
```csharp
// Assets/Happy Hotel/Shop/Scripts/ShopItems/IronSwordShopItem.cs
using UnityEngine;
using HappyHotel.Equipment.Template;

namespace HappyHotel.Shop
{
    // 购买后获得铁剑装备的商店道具
    public class IronSwordShopItem : EquipmentShopItemBase
    {
        // 铁剑基础伤害
        [SerializeField] private int damage = 3;
        
        public int Damage => damage;
        
        public void SetDamage(int newDamage)
        {
            damage = Mathf.Max(0, newDamage);
        }
        
        protected override void OnTemplateSet()
        {
            base.OnTemplateSet();
            
            // 从铁剑商店道具模板中读取伤害值
            if (template is WeaponTemplate weaponTemplate)
            {
                damage = weaponTemplate.weaponDamage;
            }
        }
        
        public override bool CanAddToInventory()
        {
            // 检查基础条件
            if (!base.CanAddToInventory())
            {
                return false;
            }
            
            // 这里我们允许拥有多个铁剑
            return true;
        }
        
        protected override string FormatDescriptionInternal(string formattedDescription)
        {
            // 为铁剑商店道具添加特定的占位符替换
            return formattedDescription
                .Replace("{damage}", damage.ToString())
                .Replace("{weaponType}", "铁剑")
                .Replace("{effect}", "攻击");
        }
    }
}
```

#### 4.2 升级版商店物品类
```csharp
// Assets/Happy Hotel/Shop/Scripts/ShopItems/IronSwordPlusShopItem.cs
using UnityEngine;
using HappyHotel.Equipment.Template;

namespace HappyHotel.Shop
{
    // 购买后获得铁剑+装备的商店道具
    public class IronSwordPlusShopItem : EquipmentShopItemBase
    {
        // 铁剑+基础伤害
        [SerializeField] private int damage = 5;
        
        public int Damage => damage;
        
        public void SetDamage(int newDamage)
        {
            damage = Mathf.Max(0, newDamage);
        }
        
        protected override void OnTemplateSet()
        {
            base.OnTemplateSet();
            
            // 从铁剑+商店道具模板中读取伤害值
            if (template is WeaponTemplate weaponTemplate)
            {
                damage = weaponTemplate.weaponDamage;
            }
        }
        
        public override bool CanAddToInventory()
        {
            // 检查基础条件
            if (!base.CanAddToInventory())
            {
                return false;
            }
            
            // 这里我们允许拥有多个铁剑+
            return true;
        }
        
        protected override string FormatDescriptionInternal(string formattedDescription)
        {
            // 为铁剑+商店道具添加特定的占位符替换
            return formattedDescription
                .Replace("{damage}", damage.ToString())
                .Replace("{weaponType}", "铁剑+")
                .Replace("{effect}", "升级版攻击");
        }
    }
}
```

### 第五步：配置 Template 资源文件

#### 5.1 创建基础装备模板资源
在 Unity 编辑器中：
1. 右键点击 `Assets/Happy Hotel/Equipment/Resources/Templates/` 文件夹
2. 选择 `Create > Happy Hotel > Item > Iron Sword Template`
3. 命名为 `Iron Sword Template`
4. 在 Inspector 中配置：
   - `itemName`: "铁剑"
   - `description`: "一把锋利的铁剑，造成{damage}点伤害"
   - `rarity`: Common
   - `weaponDamage`: 3
   - `isUpgradeable`: true
   - `upgradedEquipmentTypeId`: "IronSwordPlus"
   - `isUpgradedEquipment`: false

#### 5.2 创建升级版装备模板资源

**方案一：复用基础模板类（推荐）**
1. 右键点击 `Assets/Happy Hotel/Equipment/Resources/Templates/` 文件夹
2. 选择 `Create > Happy Hotel > Item > Iron Sword Template`（使用与基础版本相同的模板类）
3. 命名为 `Iron Sword Plus Template`
4. 在 Inspector 中配置：
   - `itemName`: "铁剑+"
   - `description`: "升级版铁剑，造成{damage}点伤害"
   - `rarity`: Uncommon
   - `weaponDamage`: 5
   - `isUpgradeable`: false
   - `isUpgradedEquipment`: true
   - `baseEquipmentTypeId`: "IronSword"

**方案二：使用独立模板类（仅当需要额外字段时）**
1. 右键点击 `Assets/Happy Hotel/Equipment/Resources/Templates/` 文件夹
2. 选择 `Create > Happy Hotel > Item > Iron Sword Plus Template`
3. 命名为 `Iron Sword Plus Template`
4. 配置同上

**模板复用说明**: 
- 如果升级版装备与基础版装备使用相同的数据字段，强烈建议复用基础版本的模板类
- 这样可以减少代码维护成本，避免重复定义
- 只有当升级版需要额外的独特字段时，才创建新的模板类

### 第六步：创建工厂类

系统中需要为 ShopItem、Equipment 和 Prop 分别创建对应的工厂类，每种工厂有不同的实现方式和用途。

#### 6.1 ShopItem 工厂类

ShopItem 工厂负责创建商店中的可购买物品，需要创建 GameObject 并添加组件。

**基础装备 ShopItem 工厂**:
```csharp
// Assets/Happy Hotel/Shop/Scripts/Factories/IronSwordShopItemFactory.cs
using HappyHotel.Shop.Factory;

namespace HappyHotel.Shop.Factories
{
    [ShopItemRegistration(
        "IronSword",
        "Templates/Iron Sword Template")]
    public class IronSwordShopItemFactory : ShopItemFactoryBase<IronSwordShopItem>
    {
    }
}
```

**升级版装备 ShopItem 工厂**:
```csharp
// Assets/Happy Hotel/Shop/Scripts/Factories/IronSwordPlusShopItemFactory.cs
using HappyHotel.Shop.Factory;
using UnityEngine;

namespace HappyHotel.Shop.Factories
{
    [ShopItemRegistration(
        "IronSwordPlus", 
        "Templates/Iron Sword Plus Template")]
    public class IronSwordPlusShopItemFactory : ShopItemFactoryBase<IronSwordPlusShopItem>
    {
    }
}
```

#### 6.2 Equipment 工厂类

Equipment 工厂负责创建背包中的装备实例，直接创建 C# 对象，不涉及 GameObject。

**基础装备 Equipment 工厂**:
```csharp
// Assets/Happy Hotel/Equipment/Scripts/Factories/IronSwordFactory.cs
namespace HappyHotel.Equipment.Factories
{
    [EquipmentRegistration(
        "IronSword",
        "Templates/Iron Sword Template")]
    public class IronSwordFactory : EquipmentFactoryBase<IronSword>
    {
        // 无需重写父类方法
    }
}
```

**升级版装备 Equipment 工厂**:
```csharp
// Assets/Happy Hotel/Equipment/Scripts/Factories/IronSwordPlusFactory.cs
using HappyHotel.Equipment.Factory;

namespace HappyHotel.Equipment.Factory
{
    [EquipmentRegistration(
        "IronSwordPlus",
        "Templates/Iron Sword Plus Template")]
    public class IronSwordPlusFactory : EquipmentFactoryBase<IronSwordPlus>
    {
    }
}
```

#### 6.3 Prop 工厂类

Prop 工厂负责创建地图上的实际道具对象，需要创建 GameObject 并添加必要的组件（如 SpriteRenderer）。

**基础装备 Prop 工厂**:
```csharp
// Assets/Happy Hotel/Prop/Scripts/Factories/IronSwordPropFactory.cs
using HappyHotel.Prop.Factory;
using UnityEngine;

namespace HappyHotel.Prop.Factories
{
    [PropRegistration(
        "IronSword",
        "Templates/Iron Sword Template")]
    public class IronSwordPropFactory : PropFactoryBase<IronSwordProp>
    {
    }
}
```

**升级版装备 Prop 工厂**:
```csharp
// Assets/Happy Hotel/Prop/Scripts/Factories/IronSwordPlusPropFactory.cs
using HappyHotel.Prop.Factory;
using UnityEngine;

namespace HappyHotel.Prop.Factories
{
    [PropRegistration(
        "IronSwordPlus",
        "Templates/Iron Sword Plus Template")]
    public class IronSwordPlusPropFactory : PropFactoryBase<IronSwordPlusProp>
    {
    }
}
```

#### 6.4 三种工厂的区别

| 工厂类型 | 基类 | 注册特性 | 用途 |
|---------|------|----------|----------|
| **ShopItem工厂** | `ShopItemFactoryBase<T>` | `[ShopItemRegistration]` | 商店购买物品 |
| **Equipment工厂** | `EquipmentFactoryBase<T>` | `[EquipmentRegistration]` | 背包装备实例 |
| **Prop工厂** | `PropFactoryBase<T>` | `[PropRegistration]` | 地图道具对象 |

## 关键概念说明

### Template 系统
- **EquipmentTemplate**: 装备基础模板，包含升级系统配置
- **WeaponTemplate**: 武器模板，继承自 EquipmentTemplate，添加 weaponDamage 字段
- 模板文件存储在 `Resources/Templates/` 目录下，通过 Unity 的 CreateAssetMenu 创建
- **模板复用**: 升级版装备可以复用基础版本的模板类，只需创建不同配置的资源文件

### 升级系统
通过 EquipmentTemplate 中的以下字段实现：
- `isUpgradeable`: 是否可升级
- `upgradedEquipmentTypeId`: 升级后的装备类型ID
- `isUpgradedEquipment`: 是否为升级后装备
- `baseEquipmentTypeId`: 基础装备类型ID（用于升级后装备）

### 工厂系统
系统包含三种不同的工厂类型，各有不同的职责和实现方式：

- **ShopItemFactory**: 负责创建商店中的可购买物品
  - 继承自 `ShopItemFactoryBase<T>`
  - 使用 `[ShopItemRegistration]` 特性注册
  
- **EquipmentFactory**: 负责创建背包中的装备实例
  - 继承自 `EquipmentFactoryBase<T>`
  - 使用 `[EquipmentRegistration]` 特性注册
  
- **PropFactory**: 负责创建地图上的道具对象
  - 继承自 `PropFactoryBase<T>`
  - 使用 `[PropRegistration]` 特性注册

### 数据流转
1. **购买流程**: ShopItemFactory -> ShopItem -> EquipmentFactory -> Equipment -> Inventory
2. **使用流程**: Equipment -> PropFactory -> Prop -> 游戏逻辑
3. **配置流程**: Template -> OnTemplateSet() -> 各类属性设置

### 命名约定
- 基础装备: `IronSword`
- 升级版装备: `IronSwordPlus`
- 对应的 Prop: `IronSwordProp`, `IronSwordPlusProp`
- 对应的 ShopItem: `IronSwordShopItem`, `IronSwordPlusShopItem`
- 对应的工厂类:
  - ShopItemFactory: `IronSwordShopItemFactory`, `IronSwordPlusShopItemFactory`
  - EquipmentFactory: `IronSwordFactory`, `IronSwordPlusFactory`
  - PropFactory: `IronSwordPropFactory`, `IronSwordPlusPropFactory`
- 对应的 Template: `IronSwordTemplate`（基础和升级版可复用同一模板类）

## 注意事项

1. **继承关系**: 所有装备类必须继承自对应的基类
2. **Template 设置**: 通过 `OnTemplateSet()` 方法从模板中读取配置，而不是通过构造函数参数
3. **Registry 注册**: 确保所有新类型都正确注册到 Registry 系统
4. **三套工厂**: 每个装备都需要创建三套工厂类（ShopItem、Equipment、Prop），各有不同的注册特性和创建方法
5. **工厂注册特性**: 
   - ShopItem 使用 `[ShopItemRegistration]`
   - Equipment 使用 `[EquipmentRegistration]`
   - Prop 使用 `[PropRegistration]`
6. **占位符替换**: 在 `FormatDescriptionInternal()` 中实现描述文本的占位符替换
7. **升级关系**: 基础装备和升级版装备需要在模板中正确设置相互引用关系
8. **模板复用**: 优先考虑复用基础版本的模板类，减少代码维护成本
9. **TypeId 一致性**: 确保在所有系统中使用的 TypeId 字符串完全一致
10. **私有字段类型**: 
     - 整数数值使用 `EquipmentValue` 类型
     - 攻击伤害类数值使用 `AttackEquipmentValue` 类型

## 最佳实践

1. **模板复用**: 如果升级版装备与基础版装备使用相同的数据字段，直接复用基础模板类
2. **渐进开发**: 先实现基础版本，测试无误后再添加升级版本
3. **命名规范**: 严格遵循命名约定，保持代码的可读性和维护性
4. **工厂统一**: 确保三套工厂类使用相同的 TypeId 字符串，保持系统一致性
5. **分层测试**: 分别测试 ShopItem 购买、Equipment 背包管理、Prop 地图使用三个层面的功能
6. **文档更新**: 添加新装备后及时更新相关文档和注释

## 完整开发清单

为每个新装备创建以下文件：

**基础装备**:
- [ ] Template 类（可选，如复用现有模板则跳过）
- [ ] Equipment 类
- [ ] Prop 类  
- [ ] ShopItem 类
- [ ] ShopItemFactory 类
- [ ] EquipmentFactory 类
- [ ] PropFactory 类
- [ ] Template 资源文件

**升级版装备**:
- [ ] Template 类（可选，推荐复用基础版本）
- [ ] Equipment 类
- [ ] Prop 类
- [ ] ShopItem 类  
- [ ] ShopItemFactory 类
- [ ] EquipmentFactory 类
- [ ] PropFactory 类
- [ ] Template 资源文件

通过以上步骤，您就可以成功添加一个新装备及其升级版本到游戏中。记住要保持命名的一致性，优先考虑模板复用，创建完整的三套工厂类，并确保所有组件都正确实现了必要的接口和方法。